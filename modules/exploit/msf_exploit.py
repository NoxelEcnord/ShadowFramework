from utils.msf_bridge import MSFBridge
from rich.console import Console

console = Console()

class Module:
    MODULE_INFO = {
        'name': 'exploit/msf_exploit',
        'description': 'Bridge module to run any Metasploit module directly from ShadowFramework.',
        'options': {
            'MSF_PATH': 'Path to the Metasploit module (e.g., exploit/unix/ftp/vsftpd_234_backdoor)',
            'RHOSTS': 'Target address(es)',
            'RPORT': 'Target port',
            'LHOST': 'Local listener address (for reverse payloads)',
            'LPORT': 'Local listener port',
            'EXTRA_OPTS': 'Additional options in format KEY=VAL,KEY2=VAL2'
        }
    }

    def __init__(self, framework):
        self.framework = framework

    def run(self):
        msf_path = self.framework.options.get('MSF_PATH')
        if not msf_path:
            console.print("[red][!] MSF_PATH is required.[/red]")
            return

        # Prepare options for MSF
        options = {
            'RHOSTS': self.framework.options.get('RHOSTS'),
            'RPORT': self.framework.options.get('RPORT'),
            'LHOST': self.framework.options.get('LHOST'),
            'LPORT': self.framework.options.get('LPORT'),
        }

        # Handle extra options
        extra = self.framework.options.get('EXTRA_OPTS')
        if extra:
            for pair in extra.split(','):
                if '=' in pair:
                    k, v = pair.split('=', 1)
                    options[k.strip()] = v.strip()

        MSFBridge.run_module(msf_path, options)
